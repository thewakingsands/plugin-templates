var languagepack = 
{
	"Attack":"공격",
	"Shot":"공격",
	"Volley Fire":"집중 사격",

	"Mage's Balled":"현자의 담시곡",
	"Foe Requiem":"마인의 진혼곡",
	"Army's Paeon":"군신의 찬가",
	"Rain of Death":"죽음의 화살비",
	"Battle Voice":"전장의 서곡",
	"Vanderer's Minuet":"여행신의 무곡",
	"Empyreal Arrow":"천상의 화살",
	"Iron Jaws":"굳은 결의",
	"Warden's Paean":"시간신의 찬미가",
	"Sidewinder":"독사 강습",
	"Heavy Shot":"육중한 사격",
	"Straight Shot":"직선 사격",
	"Raging Strikes":"용맹한 사격",
	"Venomous Bite":"독화살",
	"Misery's End":"고통 종결",
	"Shadowbind":"그림자 묶기",
	"Bloodletter":"사혈 화살",
	"Repelling Shot":"후퇴 사격",
	"Quick Nock":"재빠른 활시위",
	"Swiftsong":"질주의 노래",
	"Hawk's Eye":"매의 눈",
	"Windbite":"바람 화살",
	"Quelling Strikes":"고요한 사격",
	"Barrage":"마구 쏘기",
	"Blunt Arrow":"침묵의 화살",
	"Flaming Arrow":"불타는 화살",
	"Wide Volley":"일제 사격",
	"Sword Oath":"충의의 검",
	"Cover":"감싸기",
	"Shield Oath":"충의의 방패",
	"Spirits Within":"내면의 기개",
	"Hallowed Ground":"천하무적",
	"Sheltron":"방벽",
	"Goring Blade":"꿰뚫는 검격",
	"Divine Veil":"신성한 보호막",
	"Clemency":"관용",
	"Royal Authority":"제왕의 권위",
	"Fast Blade":"재빠른 검격",
	"Rampart":"철벽 방어",
	"Savage Blade":"야성의 검격",
	"Fight of Flight":"임전무퇴",
	"Flash":"플래시",
	"Convalescence":"재활",
	"Riot Blade":"폭도의 검격",
	"Shield Lob":"방패 던지기",
	"Shield Bash":"방패 후려치기",
	"Provoke":"도발",
	"Rage Of Halone":"할로네의 분노",
	"Shield Swipe":"방패 가격",
	"Awareness":"경각심",
	"Sentinel":"경계",
	"Tempered Will":"강철의 의지",
	"Bulwark":"방패 각성",
	"Circle of Scorn":"파멸의 진",
	"Jump":"점프",
	"Elusive Jump":"교묘한 점프",
	"Spineshatter Dive":"척추 강타",
	"Power Surge":"용의 창",
	"Dragonfire Dive":"화룡강타",
	"Battle Lintany":"전투 기도",
	"Blood of the Dragon":"푸른 용혈",
	"Fang and Claw":"용의 발톱",
	"Wheeling Thrust":"용의 꼬리",
	"Geirskogul":"게이르스코굴",
	"True Thrust":"직선 찌르기",
	"Feint":"눈속임 공격",
	"Vorpal Thrust":"사선 찌르기",
	"Keen Flurry":"날카로운 돌풍",
	"Impulse Drive":"연쇄 충격",
	"Leg Sweep":"다리 쳐내기",
	"Heavy Thrust":"겹찌르기",
	"Piercing Talon":"창던지기",
	"Life Surge":"생명력 쇄도",
	"Invigorate":"기합",
	"Full Thrust":"올려 찌르기",
	"Phlebotomize":"연속 찌르기",
	"Blood for Blood":"필사의 각오",
	"Disembowel":"몸통 가르기",
	"Doom Spike":"악몽의 쐐기",
	"Ring of Thorns":"가시 소용돌이",
	"Chaos Thrust":"꽃잎 폭풍",
	"Inner Beast":"원초의 혼",
	"Steel Cyclone":"강철 소용돌이",
	"Fell Cleave":"참수",
	"Equilibrium":"평정심",
	"Decimate":"섬멸",
	"Heavy Swing":"육중한 일격",
	"Skull Sunder":"두개골 파쇄",
	"Fracture":"골절",
	"Brutal Swing":"잔혹한 일격",
	"Overpower":"압도",
	"Tomahawk":"도끼 던지기",
	"Maim":"관절 파괴",
	"Mercy Stroke":"최후의 일격",
	"Butcher's Block":"휘도는 도끼",
	"Thrill Of Battle":"전투의 짜릿함",
	"Storm's Path":"폭풍 쐐기",
	"Vengeance":"보복",
	"Strom's Eye":"폭풍의 눈",
	"Rockbreaker":"지열참",
	"Shoulder Tackle":"나찰충격권",
	"Fists of Fire":"홍련 태세",
	"One Ilm Punch":"촌경",
	"Dragon Kick":"쌍룡각",
	"From Shift":"연무",
	"Meditation":"투기",
	"The Forbidden Chakra":"음양투기참",
	"Purification":"기공술",
	"Elixir Field":"창기포",
	"Tornado Kick":"투혼선풍각",
	"Bootshine":"연격",
	"True Strike":"정권",
	"Snap Punch":"봉권",
	"Haymaker":"되받아치기",
	"Touch of Death":"혈도 찌르기",
	"Twin Snakes":"쌍장타",
	"Arm of the Destroyer":"충격파",
	"Demolish":"파쇄권",
	"Steel Peak":"철산고",
	"Howling Fist":"공명권",
	"Perfect Balance":"진각",
	"Second Wind":"내단",
	"Fuma Shuriken":"풍마 수리검",
	"Raiton":"뇌둔술",
	"Katon":"화둔술",
	"Suiton":"수둔술",
	"Doton":"토둔술",
	"Hyoton":"빙둔술",
	"Armor Crush":"갑각파황격",
	"Duality":"일쌍",
	"Dream Within a Dream":"몽환삼단",
	"Spinning Edge":"쌍검 회전베기",
	"Gust Slash":"돌풍 베기",
	"Mutilate":"무쌍베기",
	"Assassinate":"마지막 일격",
	"Throwing Dagger":"칼 던지기",
	"Mug":"약탈",
	"Sneak Attack":"기습 공격",
	"Aeolian Edge":"칼날 선풍",
	"Jugulate":"목 따기",
	"Dancing Edge":"춤추는 칼날",
	"Death Blossom":"피의 비",
	"Shadow Fang":"그림자 송곳니",
	"Trick Attack":"속임수 공격",
	"Split Shot":"분열탄",
	"Slug Shot":"슬러그탄",
	"Lead Shot":"산탄 사격",
	"Heartbreak":"심장 관통",
	"Leg Graze":"다리 쏘기",
	"Blank":"공포탄",
	"Spread Shot":"확산 사격",
	"Foot Graze":"발 쏘기",
	"Hot Shot":"강렬한 사격",
	"Head Graze":"머리 쏘기",
	"Clean Shot":"정밀탄",
	"Wildfire":"소이탄",
	"Suppressive Fire":"제압 사격",
	"Grenado Shot":"유탄 발사",
	"Gauss Round":"가우스탄",
	"Ricochet":"도탄 사격",
	"Hard Slash":"강렬한 참격",
	"Shadowskin":"그림자 비호",
	"Spinning Slash":"회전 참격",
	"Scourge":"재앙",
	"Unleash":"촉발",
	"Low Blow":"비열한 참격",
	"Syphon Strike":"흡수의 일격",
	"Unmend":"살의",
	"Reprisal":"앙갚음",
	"Power Slash":"대참격",
	"Souleater":"흡혼검",
	"Dark Passenger":"어둠의 여행자",
	"Delirium":"열광검",
	"Salted Earth":"감염 지대",
	"Plunge":"돌진",
	"Abyssal Drain":"심연의 갈증",
	"Sole Survivor":"최후의 생존자",
	"Carve And Spit":"난도질",
	"Freeze":"프리즈",
	"Fire":"파이어",
	"Fire II":"파이라",
	"Fire III":"파이가",
	"Fire IV":"파이쟈",
	"Flare":"플레어",
	"Blizzard":"블리자드",
	"Blizzard II":"블리자라",
	"Blizzard III":"블리자가",
	"Blizzard IV":"블리자쟈",
	"Thunder":"썬더",
	"Thunder II":"썬더라",
	"Thunder III":"썬더가",
	"Stone I":"스톤",
	"Stone II":"스톤라",
	"Stone III":"스톤가",
	"Holy":"홀리",
	"Benediction":"거룩한 축복",
	"Cure":"케알",
	"Cure II":"케알라",
	"Cure III":"케알가",
	"Medica":"메디카",
	"Medica II":"메디카라",
	"Asylum":"성소",
	"Aero":"에어로",
	"Aero II":"에어로라",
	"Aero III":"에어로가",
	"Assize":"심판",
	"Tetragrammaton":"신의 이름",
	"Ruin":"루인",
	"Ruin II":"루인라",
	"Ruin III":"루인가",
	"Bio":"바이오",
	"Bio II":"바이오라",
	"Energy Drain":"에테르 흡수",
	"Physick":"치유술",
	"Miasma":"미아즈마",
	"Miasma II":"미아즈라",
	"Fester":"미아즈마 버스트",
	"Sustain":"격려",
	"Eye for an Eye":"눈에는 눈",
	"Shadow Flare":"섀도우 플레어",
	"Enkindle":"점화",
	"Painflare":"고통의 불길",
	"Tri-disaster":"트라이디재스터",
	"Deathflare":"데스 플레어",
	"Adloquium":"고무격려책",
	"Succor":"사기고양책",
	"Lustrate":"생명활성술",
	"Indomitability":"불굴불요책",
	"Broil":"기염법",
	"Emergency Tactics":"응급 전술",
	"Dissipation":"에테르 전환",
	"Essential Dignity":"본질적 위계",
	"Benefic":"베네피크",
	"Benefic II":"베네피라",
	"Malefic":"말레피크",
	"Malefic II":"말레피라",
	"Helios":"헬리오스",
	"Stella":"스텔라",
	"Aspected Benefic":"별읽기: 베네피크",
	"Aspected Helios":"별읽기: 헬리오스",
	"Gravity":"그라비데",
	"Collective Unconscious":"운명의 수레바퀴",
	"Celestial Opposition":"천궁의 반목",
	"Combust":"컴버스",
	"Combust II":"컴버라",

	"Braver":"브레이버",
	"Bladedance":"쾌검난무",
	"Final Heaven":"파이널 헤븐[몽크]",
	"Dragonsong Dive":"창룡 강타[용기]",
	"Chimatsuri":"피의 축제[닌자]",

	"Big Shot":"분노의 사격",
	"Desperado":"무법자",
	"Satellite Beam":"위성 저격[기공]",
	"Saggitarius Arrow":"궁수자리 화살[음유]",

	"Skyshard":"하늘의 조각",
	"Starstorm":"프티 메테오",
	"Meteor":"메테오[흑마]",
	"Teraflare":"테라플레어[소환]",

	"Healing Wind":"치유의 바람",
	"Breath of the Earth":"대지의 숨결",
	"Pulse of Life":"생명의 고동[백마]",
	"Angel Feathers":"천사의 깃털[학자]",
	"Astral Stasis":"천궁의 문[점성]",
};
var combatants = [];
var lastEncounter = null;
var lastEncounterRecord = [];
var onPlayRecord =false;
var onRecord = false;
var sortkey = "encdps";
var sorttype = "asc";
var lastCombat = null;
var websoket = null;
var mixeddps = null;
$(document).ready(function() 
{
	init();
	document.addEventListener('onOverlayDataUpdate', onOverlayDataUpdate);
	window.addEventListener('message', onMessage);
});

function onMessage(e) 
{
	if (e.data.type === 'onOverlayDataUpdate') 
		onOverlayDataUpdate(e.data);
}

// ACTWebSocket 적용
function connectWebSocket(uri)
{
	if(uri.indexOf("@HOST_PORT@") > -1) return;
	websocket = new WebSocket(uri);

	websocket.onmessage = function(evt) 
	{
		if (evt.data == ".") 
			websocket.send(".");
		else 
			document.dispatchEvent(new CustomEvent('onOverlayDataUpdate', { detail: JSON.parse(evt.data) }));
	};

	websocket.onclose = function(evt) 
	{ 
		setTimeout(function(){connectWebSocket(uri)}, 5000);
	};

	websocket.onerror = function(evt) 
	{
		websocket.close();
	};
}    
connectWebSocket(wsUri);

function getItem(id)
{
	if($(".content .item[data-id=\""+id+"\"]").length > 0)
		return $(".content .item[data-id=\""+id+"\"]");
	else
		return false;
}

function modifyItem(e)
{
	var item = getItem(e.name);
	
	if(e.avatar)
		$(item).find(".icon").css({"background-image":"url(./config/fancy/icon/AVA.png)", "background-size":"20px auto", "background-position":"0px 3px"});

	$(item).attr("data-job", e.combatant.Job.toUpperCase());
	$(item).find(".datas>.values>.vv>span").remove();

	if($(item).find(".datas>.values>i").length == 0)
		$(item).find(".datas>.values").append("<i style=\"width:120px; overflow:hidden; word-break:none;\">"+e.name+"</i>");

	if($("#nicknamehide").attr("data-checked")=="true" && e.name != "YOU" && e.name != "Limit Break")
		$(item).find(".datas>.values>i").css("-webkit-filter","blur(3px)");
	else
		$(item).find(".datas>.values>i").css("-webkit-filter","");

	for(var i in sortObject[selectTab])
	{
		var text = i;
		if(sortObject[selectTab][i].display)
			$(item).find(".datas>.values>.vv").append("<span style=\"float:left; overflow:hidden; margin-left:3px; text-align:center; font-family:'微软雅黑';"+(sortObject[selectTab][i].width===undefined?" width:38px;":" width:"+sortObject[selectTab][i].width+"px;")+"\">"+e.combat[i]+"</div>");
	}

	var toprank = 0;
	var isallzero = true;

	var sortkeyD = sortkey;

	if(sortkeyD == "encdps")
		sortkeyD = "damage";
	else if(sortkeyD == "enchps")
		sortkeyD = "healed";

	for(var i in lastCombat)
	{
		if(sorttype=="asc")
		{
			toprank=lastCombat[i].combat;
			if(lastCombat[i].combat[sortkeyD] != 0) isallzero = false;
			break;
		}
		else
			toprank=lastCombat[i].combat;
	}

	var mixed = (e.combat[sortkeyD] / toprank[sortkeyD])*100;
	if(sortkeyD=="maxhit"||sortkeyD=="maxheal")
	{
		mixed = (e.combat[sortkeyD].split("-")[1] / toprank[sortkeyD].split("-")[1])*100;
	}

	if(toprank[sortkeyD] == 0 && isallzero)
		mixed = 100;

	if(mixed == 0)
		mixed = 1;

	$(item).css({"top":(e.rank*24), "z-index":(25-e.rank), "opacity":1});
	$(item).find(".bar").width(mixed+"%");
}

function encounterAct(e, n)
{
	if(e==null) return;
	var _a = e.detail.Encounter.title;
	var _b = parseFloat(e.detail.Encounter.encdps).toFixed(0);
	var _c = e.detail.Encounter.duration.replace(":","_");
	var combatant = [];
	var reg = /(.*?)\s\((.*?)\)/im;
	var idx=0;
	var avatars = 
	{
		"자동포탑 룩":"MCH",
		"자동포탑 비숍":"MCH",
		"요정 에오스":"SCH",
		"요정 셀레네":"SCH",
		"카벙클 에메랄드":"SMN",
		"카벙클 토파즈":"SMN",
		"가루다 에기":"SMN",
		"타이탄 에기":"SMN",
		"이프리트 에기":"SMN"
	}

	$("header .title").html(e.detail.Encounter.title=="Encounter"?"战斗中...":e.detail.Encounter.title);
	$("header .duration").html(e.detail.Encounter.duration);
	$("header .rdps").html(parseInt(e.detail.Encounter.encdps)+" RD");
	$("header .rhps").html(parseInt(e.detail.Encounter.enchps)+ " RH");
	$("header .rdamage").html(parseInt(e.detail.Encounter.damage)+" TD");
	$("header .rhealed").html(parseInt(e.detail.Encounter.healed)+ " TH");

	for(var user in e.detail.Combatant)
	{
		var c = e.detail.Combatant[user];
		combatant.push(
		{
			"dps":c.encdps, 
			"name":c.name,
			"rank":0,
			"combat": getCombatantDetail(c, e.detail.Encounter),
			"combatant":c,
			"avatar":false,
		});
	}
	
	lastEncounter = e;
	lastCombat = combatant;

	for(var user in combatant)
	{
		var find = false;
		var matches = combatant[user].name.match(reg);
		for(var i in combatants)
		{
			if(combatants[i]==combatant[user].name)
			{
				find = true;
			}
		}

		if(!find && combatant[user].combatant.Job != "" && combatant[user].name != "YOU")
		{
			combatants.push(combatant[user].name);
		}

		if(combatant[user].name == "Limit Break")
			combatant[user].combatant.Job = "LMB";
			
		try
		{
			var iscombat = false;
			if(reg.test(combatant[user].name))
			{
				isAvatar = true;
				for(var j in avatars)
				{
					if(j==matches[1])
					{
						isAvatar = true;
						break;
					}
				}
			}

			switch(matches[1])
			{
				case "자동포탑 룩": combatant[user].combatant.Job = "Mch"; combatant[user].avatar = true; break;
				case "자동포탑 비숍": combatant[user].combatant.Job = "Mch"; combatant[user].avatar = true; break;
				case "요정 에오스": combatant[user].combatant.Job = "Sch"; combatant[user].avatar = true; break;
				case "요정 셀레네": combatant[user].combatant.Job = "Sch"; combatant[user].avatar = true; break;
				case "카벙클 에메랄드": combatant[user].combatant.Job = "Smn"; combatant[user].avatar = true; break;
				case "카벙클 토파즈": combatant[user].combatant.Job = "Smn"; combatant[user].avatar = true; break;
				case "가루다 에기": combatant[user].combatant.Job = "Smn"; combatant[user].avatar = true; break;
				case "타이탄 에기": combatant[user].combatant.Job = "Smn"; combatant[user].avatar = true; break;
				case "이프리트 에기": combatant[user].combatant.Job = "Smn"; combatant[user].avatar = true; break;
			}

			for(var i in combatants)
			{
				if(combatants[i]==matches[2])
				{
					iscombat = true;
				}
			}

			if(iscombat && $("#mergeAvatar").attr("data-checked") == "true")
			{
				var finduser = -1;
				for(var i in combatant)
				{
					if(combatant[i].name == matches[2] || (combatant[i].name == "YOU" && myname.find(function(e){return e == matches[2]}) != null))
					{
						finduser = i;
					}
				}

				if(finduser>-1)
				{
					combatant[finduser].combat = mergeCombatantDetail(combatant[finduser].combat, combatant[user].combat, e);
					delete combatant[user];
				}
			}
		}
		catch(ex)
		{
			
		}
	}

	for(var n in combatant)
	{
		for(var u in combatant[n].combat)
		{
			if(u=="maxhit" || u=="maxheal") continue;
			combatant[n].combat[u] = convNumberFix(combatant[n].combat[u]);
		}
	}

	if(sortkey=="maxhit" || sortkey=="maxheal")
	{
		if(sorttype == "desc")
		{
			combatant.sort(function(b, a){return parseFloat(b.combat[sortkey].split("-")[1]) - parseFloat(a.combat[sortkey].split("-")[1])});
		}
		else
		{
			combatant.sort(function(a, b){return parseFloat(b.combat[sortkey].split("-")[1]) - parseFloat(a.combat[sortkey].split("-")[1])});
		}
	}
	else
	{
		if(sorttype == "desc")
		{
			combatant.sort(function(b, a){return parseFloat(b.combat[sortkey]) - parseFloat(a.combat[sortkey])});
		}
		else
		{
			combatant.sort(function(a, b){return parseFloat(b.combat[sortkey]) - parseFloat(a.combat[sortkey])});
		}
	}

	mixeddps = combatant;

	if($(".battlelog").find("div[data=\""+_a+"|"+_b+"|"+_c+"\"]").length == 0 && e.detail.Encounter.title != "Encounter")
	{
		$(".battlelog").prepend("<div select='no' data='"+_a+"|"+_b+"|"+_c+"' idx='"+(lastEncounterRecord+1)+"'>"+e.detail.Encounter.title+" ("+parseInt(e.detail.Encounter.encdps)+" RDPS)</div>");
		lastEncounterRecord.push(e);
		$(".battlelog div[data=\""+_a+"|"+_b+"|"+_c+"\"]").attr("select","yes");

		$(".battlelog div[data=\""+_a+"|"+_b+"|"+_c+"\"]").click(function(){
			if(lastEncounter.detail.Encounter.title != "Encounter")
			{
				encounterAct(e, false);
				$(".battlelog div").each(function(){$(this).attr("select", "no")});
				$(this).attr("select","yes");
				showBattleLog();
			}
		});
	}

	if($(".battlelog div").length > 20)
	{
		$(".battlelog div")[20].remove();
	}
		
	for(var user in combatant)
	{
		combatant[user].rank = idx++;
		addItem(combatant[user]);
	}

	$(".content .item").each(function()
	{
		var remove = true;
		for(var i in combatant)
		{
			if($(this).attr("data-id") == combatant[i].name) remove = false;
		}
	
		if(remove)
			$(this).remove();
	});
}

function mergeCombatantDetail(original, target, e)
{
	original.swings += parseInt(target.swings);
	original.dps = (parseFloat(original.dps) + parseFloat(target.dps)).toFixed(1);
	original.encdps = (parseFloat(original.encdps) + parseFloat(target.encdps)).toFixed(1);
	original.damage += parseInt(target.damage);
	original['damage%'] = (parseInt(original.damage) / parseInt(e.detail.Encounter.damage) * 100).toFixed(1);
	original.heals += parseInt(target.heals);
	original.enchps = (parseFloat(original.enchps) + parseFloat(target.enchps)).toFixed(1);
	original.healed += parseInt(target.healed);
	original['healed%'] = (parseInt(original.healed) / parseInt(e.detail.Encounter.healed) * 100).toFixed(1);
	original.misses += parseInt(target.misses);
	original.crithits += parseInt(target.crithits);
	original.critheals += parseInt(target.critheals);
	original['crithit%'] = (parseInt(original.crithits) / parseInt(original.swings) * 100).toFixed(1);
	original['critheal%'] = (parseInt(original.critheals) / parseInt(original.heals) * 100).toFixed(1);
	original.damagetaken += parseInt(target.damagetaken);
	original.healstaken += parseInt(target.healstaken);
	original.OverHealPct += parseInt(target.OverHealPct);
	original.kills += parseInt(target.kills);
	original.cures += parseInt(target.cures);
	
	original.DirectHitPct += parseInt(target.DirectHitPct);
	original.CritDirectHitPct += parseInt(target.CritDirectHitPct);
	
	original.ParryPct += target.ParryPct;
	original.BlockPct += target.BlockPct;

	return original;
}

function getCombatantDetail(c,e)
{
	return {
			"Job":c.Job,
			"swings":parseInt(c.swings),
			"dps":parseFloat(c.dps).toFixed(1),
			"encdps":parseFloat(c.encdps).toFixed(1),
			"damage":parseInt(c.damage),
			"damage%":(parseInt(c.damage) / parseInt(e.damage) * 100).toFixed(1),
			"heals":parseInt(c.heals),
			"enchps":parseFloat(c.enchps).toFixed(1),
			"healed":parseInt(c.healed),
			"healed%":(parseInt(c.healed) / parseInt(e.healed) * 100).toFixed(1),
			"misses":parseInt(c.misses),
			"crithits":parseInt(c.crithits),
			"critheals":parseInt(c.critheals),
			"crithit%":(parseInt(c.crithits) / parseInt(c.swings) * 100).toFixed(1),
			"critheal%":(parseInt(c.critheals) / parseInt(c.heals) * 100).toFixed(1),
			"damagetaken":parseInt(c.damagetaken),
			"healstaken":parseInt(c.healstaken),
			"OverHealPct":parseInt(c.OverHealPct),
			"kills":parseInt(c.kills),
			"deaths":c.deaths,
			"maxhit":getMaxhit(c),
			"maxheal":c.maxheal,
			"duration":c.duration,
			"ParryPct":removePerc(c.ParryPct),
			"BlockPct":removePerc(c.BlockPct),
			"powerdrain":c.powerdrain,
			"powerheal":c.powerheal,
			"cures":c.cures,
			"CritDirectHitPct":parseInt(c.CritDirectHitPct),
			"DirectHitPct":parseInt(c.DirectHitPct),
		};
}

function getMaxhit(c)
{
	var str = c.maxhit.replace(/\s\(\*\)/ig, "");

	var splitedtext = str.split("-");
	if(languagepack[splitedtext[0]] != undefined)
	{
		str = languagepack[splitedtext[0]]+"-"+splitedtext[1];
	}

	return str;
}

function removePerc(v)
{
	return parseInt(v.replace(/%/ig,""));
}

function isNumber(value) 
{
	return typeof isNaN(value) && isFinite(value);
}

function convNumberFix(val)
{
	if(isNumber(val))
		return val;
	else
		return 0;
}

function getMilliTick(time)
{
	return (time.getTime()*1000) + time.getMilliseconds();
}

function showBattleLog()
{
	if($(".battlelog").css("display") == "none")
	{
		$(".content").hide();
		$(".battlelog").show();
	}
	else
	{
		$(".content").show();
		$(".battlelog").hide();
	}
}

function windowmode() 
{
	var el = document
	, rfs = // for newer Webkit and Firefox
	el.exitFullScreen
	|| el.webkitExitFullscreen
	|| el.mozCancelFullScreen
	|| el.msExitFullScreen
	rfs.call(el);
}

function fullscreen() 
{
	var el = document.documentElement
	, rfs = // for newer Webkit and Firefox
	el.requestFullScreen
	|| el.webkitRequestFullScreen
	|| el.mozRequestFullScreen
	|| el.msRequestFullscreen
	;
	rfs.call(el);
}

function isFullscreen()
{
	return (document.fullscreen || document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement);
}

function resort(obj)
{
	var tabs = "";
	var temp = "";
	var first = false;
	var sort = "";

	selectTab = $(obj).html();

	for(var i in sortObject)
	{
		tabs += "<div class=\"tab";
		if(i == selectTab)
		tabs += " seltab";
		tabs += "\" onclick=\"resort(this);\">"+i+"</div>";
	}

	for(var i in sortObject[selectTab])
	{
		if(!first)
		{
			sort = i;
			first = true;
		}

		if(sortObject[selectTab][i].display)
			temp += "<div data-sort=\"none\" data=\""+i+"\" "+(sortObject[selectTab][i].width===undefined?"":"style=\"width:"+sortObject[selectTab][i].width+"px;\"")+">"+sortObject[selectTab][i].label+"</div>";
	}

	$(".tabs").html(tabs);
	$(".datasort").html(temp);

	defaultSort = sortkey = sort;

	$(".datasort div[data=\""+defaultSort+"\"]").attr("data-sort","asc");
	encounterAct(lastEncounter, false);
	
	$(".datasort div").click(function(){
		sorttype="asc";
		if($(this).attr("data-sort") == "asc")
		{
			$(".datasort div").attr("data-sort","none");
			$(this).attr("data-sort","desc");
			sorttype="desc";
		}
		else if($(this).attr("data-sort") == "desc")
		{
			$(".datasort div").attr("data-sort","none");
			$(this).attr("data-sort","asc");
		}
		else
		{
			$(".datasort div").attr("data-sort","none");
			$(this).attr("data-sort","asc");
		}
		sortkey = $(this).attr("data");
		encounterAct(lastEncounter, false);
	});
}

function init()
{
	var version = "Beta 1.9";
	var temp = "";
	var tabs = "";
	for(var i in sortObject)
	{
		tabs += "<div class=\"tab";
		if(i == selectTab)
		tabs += " seltab";
		tabs += "\" onclick=\"resort(this);\">"+i+"</div>";
	}
	for(var i in sortObject[selectTab])
	{
		if(sortObject[selectTab][i].display)
			temp += "<div data-sort=\"none\" data=\""+i+"\" "+(sortObject[selectTab][i].width===undefined?"":"style=\"width:"+sortObject[selectTab][i].width+"px;\"")+">"+sortObject[selectTab][i].label+"</div>";
	}

	var html = "<div class=\"tooltip\"></div>"+
	"<header>"+
	"<div class=\"tabs\">"+
	tabs+
	"</div>"+
	"<div class=\"icon\" onmouseover=\"$('.tooltip').show(); $('.tooltip').css({'left':'0px', 'right':'auto', 'top':'45px'}); $('.tooltip').html('<div>战斗记录</div><div>最多可以保存20条战斗记录</div>');\" onmouseleave=\"$('.tooltip').hide();\" style=\"background:url(config/fancy/img/calendar-text.png) no-repeat center center; background-size:90% auto; float:left;\" onclick=\"if($('.title').html().toString().indexOf('집계 중') == -1){showBattleLog();}\"></div>"+
	"<div class=\"duration\">00:00</div>"+
	"<div class=\"title\">---</div>"+
	"<div class=\"datacov\"><div class=\"rdps\">0 团队秒伤</div>"+
	"<div class=\"rhps\">0 团队秒疗</div>"+
	"<div class=\"rdamage\">0 团队伤量</div>"+
	"<div class=\"rhealed\">0 团队死亡</div></div>"+
	"<div class=\"icons\">"+
	"<div class=\"icon\" onmouseover=\"$('.tooltip').show(); $('.tooltip').css({'left':'auto', 'right':'0px', 'top':'25px'}); $('.tooltip').html('<div>重载</div><div>重新加载美化模板</div>');\" onmouseleave=\"$('.tooltip').hide();\" style=\"background:url(config/fancy/img/refresh.png) no-repeat center center; background-size:100% auto;\" onclick=\"location.href=location.href;\"></div>"+
	"<div class=\"icon\" onmouseover=\"$('.tooltip').show(); $('.tooltip').css({'right':'0px', 'left':'auto', 'top':'25px'}); $('.tooltip').html('<div>召唤物统计</div><div>分离或合并召唤物统计. (※国服无效)</div>');\" onmouseleave=\"$('.tooltip').hide();\" style=\"background:url(config/fancy/img/account-multiple-plus.png) no-repeat center center; background-size:90% auto;\" data-checked=\"true\" id=\"mergeAvatar\"></div>"+
	"<div class=\"icon\" onmouseover=\"$('.tooltip').show(); $('.tooltip').css({'right':'0px', 'left':'auto', 'top':'25px'}); $('.tooltip').html('<div>模糊名字</div><div>对名字马赛克处理</div>');\" onmouseleave=\"$('.tooltip').hide();\" style=\"background:url(config/fancy/img/dns.png) no-repeat center center; background-size:90% auto;\" data-checked=\"true\" id=\"nicknamehide\"></div>"+
	"<div class=\"icon\" onmouseover=\"$('.tooltip').show(); $('.tooltip').css({'right':'0px', 'left':'auto', 'top':'25px'}); $('.tooltip').html('<div>125% 放大</div><div>整体UI放大125%</div>');\" onmouseleave=\"$('.tooltip').hide();\" style=\"background:url(config/fancy/img/fullscreen.png) no-repeat center center; background-size:90% auto;\" data-checked=\"false\" id=\"magnify\" onclick=\"magnify();\"></div></div>";
	
	if(isFullscreen())
	{
		
	}
	else
	{

	}
	html +=
	"</header>"+
	"<div class=\"datasort\">"+
	temp+
	"</div>"+
	"<div class=\"content\">"+
	"<div class=\"item\" data-job=\"WAR\">"+
	"<div class=\"icon\"></div>"+
	"<div class=\"leftdeco\"></div>"+
	"<div class=\"datas\">"+
	"</div>"+
	"</div>"+
	"</div>"+
	"<div class=\"battlelog\" style=\"display:none;\">"+
	"</div><div class=\"versions\">"+version+"</div>";

	$("body").append(html);
	if (document.addEventListener) 
	{
		window.onbeforeunload = function() 
		{
			document.removeEventListener('onOverlayDataUpdate', onOverlayDataUpdate);
			window.removeEventListener('message', onMessage);
		};

		window.addEventListener("unload", function() 
		{
			document.removeEventListener('onOverlayDataUpdate', onOverlayDataUpdate);
			window.removeEventListener('message', onMessage);
		}, false);
	}

	for(var i in myname){combatants.push(myname[i]);}
	$(".datasort div[data=\""+defaultSort+"\"]").attr("data-sort","asc");

	$(".content *").remove();

	$("header .icon[data-checked]").click(function(){
		if($(this).attr("data-checked")=="true")
			$(this).attr("data-checked", "false");
		else
			$(this).attr("data-checked", "true");
		
		encounterAct(lastEncounter, false);
	});

	$(".datasort div").click(function(){
		sorttype="asc";
		if($(this).attr("data-sort") == "asc")
		{
			$(".datasort div").attr("data-sort","none");
			$(this).attr("data-sort","desc");
			sorttype="desc";
		}
		else if($(this).attr("data-sort") == "desc")
		{
			$(".datasort div").attr("data-sort","none");
			$(this).attr("data-sort","asc");
		}
		else
		{
			$(".datasort div").attr("data-sort","none");
			$(this).attr("data-sort","asc");
		}
		sortkey = $(this).attr("data");
		encounterAct(lastEncounter, false);
	});
}

function magnify()
{
	if($("#magnify").attr("data-checked") == "false")
		$("body").css({
						"transform":"scale(1.25)",
						"left":"11%",
						"right":"11%",
						"top":"11%",
						"bottom":"11%"});
	else
		$("body").css({
						"transform":"scale(1)",
						"left":"5px",
						"right":"5px",
						"top":"5px",
						"bottom":"5px"});
}

function addItem(e)
{
	if(!getItem(e.name))
		$(".content").append("<div class=\"item\" data-job=\""+e.combatant.Job.toUpperCase()+"\" data-id=\""+e.name+"\" style=\"top:"+((e.rank+2)*27)+"px; opacity:0;\"><div class=\"icon\"></div><div class=\"leftdeco d\"></div><div class=\"leftdeco\"></div><div class=\"datas\"><div class=\"values\"><div class=\"vv\"></div></div><div class=\"bar\"></div></div></div>");
	
	modifyItem(e);
}

function removeItem(id)
{
	$(".content .item[data-id=\""+id+"\"]").remove();
}

function onOverlayDataUpdate(e)
{
	encounterAct(e, false);
	$(".loading").fadeOut();
}